<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Join - Login</title>
    <link rel="icon" href="../assets/images/logo.svg" />
    <link rel="stylesheet" href="../styles/fonts.css" />
    <link rel="stylesheet" href="../style.css" />
  </head>
  <body>
    <div class="initialView" id="introAnimation">
      <img
        id="logo-animation"
        src="../assets/images/Capa 2.png"
        alt="Responsive Image"
        onload="setTimeout(function() { 
          document.getElementById('introAnimation').classList.add('animated');
          setTimeout(function() {
            document.getElementById('mainContent').classList.add('fadeIn');
            document.getElementById('registrationSection').classList.add('fadeIn');
            document.getElementById('footerLinks').classList.add('fadeIn');
          }, 1000);
        }, 300);"
      />
    </div>
    <div class="registrationArea" id="registrationSection">
      <div>
        <p>Not A Join User?</p>
        <button
          class="actionButton standardPadding registrationBtn"
          id="signupButton"
          onclick="window.location.href='signup.html';"
        >
          Sign up
        </button>
      </div>
    </div>
    <div class="mainContainer" id="mainContent">
      <div class="authPanel">
        <div class="headingWithIndicator">
          <h1>Log in</h1>
          <div class="accentIndicator"></div>
        </div>
        <form class="authForm" id="signinForm">
          <div class="formControls">
            <div class="fieldWrapper">
              <input
                placeholder="Email"
                class="credentialField"
                type="email"
                id="loginEmail"
              /><img class="emailIcon" src="../assets/images/mail.png" alt="" />
            </div>
            <div class="fieldWrapper" id="pasowrdConteiner">
              <input
                placeholder="Password"
                class="credentialField"
                type="password"
                id="loginPassword"
              />
              <div class="visibilityToggle">
                <img
                  class="visibilityIcon"
                  src="../assets/images/lock.png"
                  id="visibility_toggle"
                  alt=""
                  onclick="togglePasswordVisibility()"
                />
              </div>
            </div>
            <div class="validationError" id="wrongPasswordConteiner"></div>
          </div>
          <div class="persistenceControl" onclick="toggleRememberOption()">
            <div class="toggleControl">
              <img id="checkbox" src="../assets/images/Rectangle1.png" />
            </div>
            <div>
              <p>Remember me</p>
            </div>
          </div>
          <div class="actionControls">
            <button
              class="actionButton mediumPadding standardHeight"
              type="submit"
              id="loginButton"
            >
              Log in
            </button>
            <button
              class="secondaryButton mediumPadding primaryTypography standardHeight"
              id="guestLoginButton"
              type="button"
            >
              Guest Log in
            </button>
          </div>
        </form>
      </div>
    </div>
    <div class="navigationLinks" id="footerLinks">
      <a href="./privacy_policy_nologin.html">Privacy Policy</a>
      <a href="./legal_notice_nologin.html">Legal notice</a>
    </div>
  </body>
  <script>
    // Basic API configuration
    const API_BASE_URL = 'http://127.0.0.1:8000/';
    
    // Toggle password visibility
    function togglePasswordVisibility() {
      const passwordField = document.getElementById('loginPassword');
      const visibilityToggle = document.getElementById('visibility_toggle');
      
      if (passwordField.type === 'password') {
        passwordField.type = 'text';
        visibilityToggle.src = '../assets/images/visibility.png';
      } else {
        passwordField.type = 'password';
        visibilityToggle.src = '../assets/images/lock.png';
      }
    }
    
    // Toggle "remember me" option
    function toggleRememberOption() {
      const checkboxElement = document.getElementById('checkbox');
      const isCurrentlyChecked = checkboxElement.src.includes('Rectangle2.png');
      
      if (isCurrentlyChecked) {
        checkboxElement.src = '../assets/images/Rectangle1.png';
        localStorage.setItem('saveCredentials', 'false');
      } else {
        checkboxElement.src = '../assets/images/Rectangle2.png';
        localStorage.setItem('saveCredentials', 'true');
        
        // Store credentials if available
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        if (email) localStorage.setItem('userIdentifier', email);
        if (password) localStorage.setItem('userSecret', password);
      }
    }
    
    // Initialize login form
    window.addEventListener('load', function() {
      // Check if credentials are saved
      const saveCredentials = localStorage.getItem('saveCredentials');
      const checkbox = document.getElementById('checkbox');
      const emailField = document.getElementById('loginEmail');
      const passwordField = document.getElementById('loginPassword');
      
      if (saveCredentials === 'true') {
        checkbox.src = '../assets/images/Rectangle2.png';
        emailField.value = localStorage.getItem('userIdentifier') || '';
        passwordField.value = localStorage.getItem('userSecret') || '';
      }
      
      // Set up form submission
      document.getElementById('signinForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        try {
          const email = emailField.value;
          const password = passwordField.value;
          
          // Check for locally stored credentials first
          const storedEmail = localStorage.getItem('userIdentifier');
          const storedPassword = localStorage.getItem('userSecret');
          
          // Allow login if credentials match what was saved during signup
          if (email === storedEmail && password === storedPassword) {
            console.log('Logging in with locally stored credentials');
            
            // Generate a mock token
            const mockToken = btoa(email + ':' + Date.now());
            
            // Store authentication data
            localStorage.setItem('token', mockToken);
            localStorage.setItem('userName', email.split('@')[0]); // Use part before @ as username
            sessionStorage.setItem('userName', email.split('@')[0]);
            
            // Save credentials if "remember me" is checked
            if (localStorage.getItem('saveCredentials') === 'true') {
              localStorage.setItem('userIdentifier', email);
              localStorage.setItem('userSecret', password);
            }
            
            // Redirect to summary page
            window.location.href = 'summary.html';
            return;
          }
          
          // Try backend login if local credentials don't match
          // Send login request
          const response = await fetch(`${API_BASE_URL}api/auth/login-token/`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email, password }),
          });
          
          // Get the response text first
          const responseText = await response.text();
          
          // Try to parse as JSON, but handle non-JSON responses gracefully
          let data;
          try {
            data = responseText ? JSON.parse(responseText) : {};
          } catch (parseError) {
            console.log('Response is not JSON:', responseText);
            data = { message: responseText || 'Unknown response from server' };
          }
          
          if (response.ok) {
            console.log('Login successful', data);
            
            // Store authentication data
            if (data.token) {
              localStorage.setItem('token', data.token);
              
              // Extract username from different possible formats
              let username = '';
              if (data.user && data.user.username) {
                username = data.user.username;
              } else if (data.username) {
                username = data.username;
              } else {
                // Fallback to email without domain
                username = email.split('@')[0];
              }
              
              localStorage.setItem('userName', username);
              sessionStorage.setItem('userName', username);
              
              // Store user profile if available
              if (data.user) {
                localStorage.setItem('userProfile', JSON.stringify(data.user));
              }
            } else {
              // If no token but still successful, create a mock token
              const mockToken = btoa(email + ':' + Date.now());
              localStorage.setItem('token', mockToken);
              localStorage.setItem('userName', email.split('@')[0]);
              sessionStorage.setItem('userName', email.split('@')[0]);
            }
            
            // Save credentials if "remember me" is checked
            if (localStorage.getItem('saveCredentials') === 'true') {
              localStorage.setItem('userIdentifier', email);
              localStorage.setItem('userSecret', password);
            }
            
            // Redirect to summary page
            window.location.href = 'summary.html';
          } else {
            // Handle login failure
            console.error('Login failed:', data);
            
            // Extract error message from different possible formats
            let errorMessage = 'Invalid email or password';
            if (typeof data === 'object') {
              if (data.detail) errorMessage = data.detail;
              else if (data.error) errorMessage = data.error;
              else if (data.message) errorMessage = data.message;
              else if (data.non_field_errors && data.non_field_errors.length > 0) {
                errorMessage = data.non_field_errors[0];
              }
            }
            
            // Show error message
            document.getElementById('wrongPasswordConteiner').textContent = errorMessage;
            document.getElementById('pasowrdConteiner').classList.add('errorState');
          }
        } catch (error) {
          console.error('Login error:', error);
          
          // If the backend is not available, try local credentials as fallback
          const email = emailField.value;
          const password = passwordField.value;
          const storedEmail = localStorage.getItem('userIdentifier');
          const storedPassword = localStorage.getItem('userSecret');
          
          if (email === storedEmail && password === storedPassword) {
            console.log('Falling back to local credentials due to server error');
            
            // Use stored credentials as backup
            const mockToken = btoa(email + ':' + Date.now());
            localStorage.setItem('token', mockToken);
            
            // Get username from localStorage if it exists
            const storedUserProfile = localStorage.getItem('userProfile');
            let username = email.split('@')[0]; // Default
            
            if (storedUserProfile) {
              try {
                const profile = JSON.parse(storedUserProfile);
                if (profile.username) {
                  username = profile.username;
                }
              } catch (e) {
                console.error('Failed to parse stored user profile:', e);
              }
            }
            
            localStorage.setItem('userName', username);
            sessionStorage.setItem('userName', username);
            
            // Redirect to summary
            window.location.href = 'summary.html';
          } else {
            // Show a network error message
            document.getElementById('wrongPasswordConteiner').textContent = 'Login failed. Please check your connection and try again.';
            document.getElementById('pasowrdConteiner').classList.add('errorState');
          }
        }
      });
      
      // Guest login
      document.getElementById('guestLoginButton').addEventListener('click', function() {
        localStorage.removeItem('greetingShown');
        sessionStorage.setItem('userName', 'Guest');
        window.location.href = 'summary.html';
      });
      
      // Signup button
      document.getElementById('signupButton').addEventListener('click', function() {
        window.location.href = 'signup.html';
      });
    });
  </script>
</html>